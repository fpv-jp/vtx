name: Build and Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"  # v0.0.1 形式のみ（-rc等は除外）

  workflow_dispatch:

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      upload_url: ${{ steps.create.outputs.upload_url }}
    steps:
      - name: Create Draft Release
        id: create
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          UPLOAD_URL=$(gh api "repos/${GITHUB_REPOSITORY}/releases" \
            -f tag_name="${GITHUB_REF_NAME}" \
            -f name="${GITHUB_REF_NAME}" \
            -F draft=true \
            -F generate_release_notes=true \
            --jq '.upload_url')
          echo "upload_url=${UPLOAD_URL}" >> "${GITHUB_OUTPUT}"

  build:
    needs: create-release
    strategy:
      matrix:
        runner:
          - raspberry-pi-5b
          - radxa-rock-5b
          - jetson-nano-2gb-devkit
          - jetson-orin-nano-super
      fail-fast: false

    permissions:
      contents: write

    runs-on:
      - self-hosted
      - ${{ matrix.runner }}

    steps:
      - name: Clean workspace
        run: rm -rf "$GITHUB_WORKSPACE"/* "$GITHUB_WORKSPACE"/.??* 2>/dev/null || true

      - name: Checkout
        run: git clone --depth 1 --branch "${GITHUB_REF_NAME}" "https://github.com/${GITHUB_REPOSITORY}.git" .

      - name: Build
        run: make all

      - name: Verify binary
        run: |
          if [ -f vtx ]; then
            echo "✓ Binary created successfully"
            ls -lh vtx
            file vtx
            echo "--- Platform detection test ---"
            cat /proc/device-tree/model 2>/dev/null || echo "device-tree not available"
          else
            echo "✗ Binary not found"
            exit 1
          fi

      - name: Upload binary to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPLOAD_URL: ${{ needs.create-release.outputs.upload_url }}
        run: |
          URL="${UPLOAD_URL%%\{*}"
          curl -sSf -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Content-Type: application/octet-stream" \
            "${URL}?name=vtx-${{ matrix.runner }}" \
            --data-binary @vtx

  finalize-release:
    needs: [create-release, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Add aliases and publish release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          REPO="${GITHUB_REPOSITORY}"
          mkdir -p assets
          gh release download "${TAG}" --repo "${REPO}" --dir assets

          echo "=== Downloaded assets ==="
          ls -lh assets/

          # Raspberry Pi aliases
          if [ -f assets/vtx-raspberry-pi-5b ]; then
            cp assets/vtx-raspberry-pi-5b assets/vtx-raspberry-pi-4b
            cp assets/vtx-raspberry-pi-5b assets/vtx-raspberry-pi-4cm
            gh release upload "${TAG}" assets/vtx-raspberry-pi-4b assets/vtx-raspberry-pi-4cm --repo "${REPO}"
          fi

          # Radxa ROCK 5 aliases
          if [ -f assets/vtx-radxa-rock-5b ]; then
            cp assets/vtx-radxa-rock-5b assets/vtx-radxa-rock-5b-plus
            cp assets/vtx-radxa-rock-5b assets/vtx-radxa-rock-5t
            gh release upload "${TAG}" assets/vtx-radxa-rock-5b-plus assets/vtx-radxa-rock-5t --repo "${REPO}"
          fi

          # Publish release (remove draft status)
          gh release edit "${TAG}" --draft=false --repo "${REPO}"

          echo "=== Final release assets ==="
          gh release view "${TAG}" --repo "${REPO}"
