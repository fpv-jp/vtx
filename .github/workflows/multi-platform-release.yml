name: Build and Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"  # v0.0.1 形式のみ（-rc等は除外）

  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        runner:
          - raspberry-pi-5b
          - radxa-rock-5b
          - jetson-nano-2gb-devkit
          - jetson-orin-nano-super
      fail-fast: false

    runs-on:
      - self-hosted
      - ${{ matrix.runner }}

    steps:
      - name: Clean workspace
        run: rm -rf "$GITHUB_WORKSPACE"/* "$GITHUB_WORKSPACE"/.??* 2>/dev/null || true

      - name: Checkout
        run: git clone --depth 1 --branch "${GITHUB_REF_NAME}" "https://github.com/${GITHUB_REPOSITORY}.git" .

      - name: Build
        run: make all

      - name: Verify binary
        run: |
          if [ -f vtx ]; then
            echo "✓ Binary created successfully"
            ls -lh vtx
            file vtx
            echo "--- Platform detection test ---"
            cat /proc/device-tree/model 2>/dev/null || echo "device-tree not available"
          else
            echo "✗ Binary not found"
            exit 1
          fi

      - name: Rename binary with runner suffix
        run: mv vtx vtx-${{ matrix.runner }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vtx-${{ matrix.runner }}
          path: vtx-${{ matrix.runner }}
          retention-days: 3

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          ls -R artifacts/
          find artifacts -type f

      - name: Prepare release files with aliases
        run: |
          mkdir -p release

          # Copy original binaries
          find artifacts -type f -exec cp -v {} release/ \;

          # Create aliases for compatible platforms
          # Raspberry Pi: raspberry-pi-5b binary works for all Pi 4/5 with same OS
          if [ -f release/vtx-raspberry-pi-5b ]; then
            cp release/vtx-raspberry-pi-5b release/vtx-raspberry-pi-4b
            cp release/vtx-raspberry-pi-5b release/vtx-raspberry-pi-4cm
          fi

          # Radxa ROCK 5: radxa-rock-5b binary works for all ROCK 5 series
          if [ -f release/vtx-radxa-rock-5b ]; then
            cp release/vtx-radxa-rock-5b release/vtx-radxa-rock-5b-plus
            cp release/vtx-radxa-rock-5b release/vtx-radxa-rock-5t
          fi

          # Jetson: each requires separate binary (no aliases)
          # jetson-nano-2gb-devkit -> vtx-jetson-nano-2gb-devkit
          # jetson-orin-nano-super -> vtx-jetson-orin-nano-super

          echo "=== Final release files ==="
          ls -lh release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
