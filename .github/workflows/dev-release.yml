name: Dev Build and Release

on:
  push:
    tags:
      - "v*-dev"

jobs:
  build:
    strategy:
      matrix:
        include:
          - platform: RPI4_V4L2
            runner: rpi4-v4l2
          # - platform: RPI4_LIBCAM
          #   runner: rpi4-libcam
          # - platform: RPI5_LIBCAM
          #   runner: rpi5-libcam
          - platform: JETSON_NANO_2GB
            runner: jetson-nano-2gb
          # - platform: JETSON_ORIN_NANO_SUPER
          #   runner: jetson-orin-nano-super
          - platform: RADXA_ROCK_5B
            runner: radxa-rock-5b
          # - platform: RADXA_ROCK_5T
          #   runner: radxa-rock-5t
      fail-fast: false

    runs-on:
      - self-hosted
      - ${{ matrix.runner }}

    steps:
      - uses: actions/checkout@v5

      - name: Build for ${{ matrix.platform }}
        run: make all PLATFORM=${{ matrix.platform }}

      - name: Verify binary
        run: |
          if [ -f vtx ]; then
            echo "✓ Binary created successfully"
            ls -lh vtx
            file vtx
          else
            echo "✗ Binary not found"
            exit 1
          fi

      - name: Rename binary with platform suffix
        run: mv vtx vtx-${{ matrix.runner }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vtx-${{ matrix.runner }}
          path: vtx-${{ matrix.runner }}
          retention-days: 3

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          ls -R artifacts/
          find artifacts -type f

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -type f -exec cp -v {} release/ \;
          ls -lh release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          draft: false
          prerelease: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
